<!DOCTYPE html>
<html lang="en-us">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>My Thoughts</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="">
    <meta name="generator" content="Hugo 0.135.0">
    
    
    
    
      <meta name="robots" content="noindex, nofollow">
    
    

    
<link rel="stylesheet" href="/ananke/css/main.min.css" >



    

    
      

    

    
    
      <link href="/posts/index.xml" rel="alternate" type="application/rss+xml" title="My Thoughts" />
      <link href="/posts/index.xml" rel="feed" type="application/rss+xml" title="My Thoughts" />
      
    

    
      <link rel="canonical" href="http://localhost:1313/posts/">
    

    <meta property="og:url" content="http://localhost:1313/posts/">
  <meta property="og:site_name" content="My Thoughts">
  <meta property="og:title" content="Posts">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="website">

  <meta itemprop="name" content="Posts">
  <meta itemprop="datePublished" content="2023-11-29T01:51:20+00:00">
  <meta itemprop="dateModified" content="2023-11-29T01:51:20+00:00">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Posts">

	
  </head>

  <body class="ma0 avenir bg-near-white">

    

  <header>
    <div class="pb3-m pb6-l bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="/" class="f3 fw2 hover-white no-underline white-90 dib">
      
        My Thoughts
      
    </a>
    <div class="flex-l items-center">
      

      
      
<div class="ananke-socials">
  
</div>

    </div>
  </div>
</nav>

      <div class="tc-l pv3 ph3 ph4-ns">
        <h1 class="f2 f-subheadline-l fw2 light-silver mb0 lh-title">
          Posts
        </h1>
        
      </div>
    </div>
  </header>


    <main class="pb7" role="main">
      
  <article class="pa3 pa4-ns nested-copy-line-height">
    <section class="cf ph3 ph5-l pv3 pv4-l f4 tc-l center measure-wide lh-copy mid-gray"></section>
    <section class="flex-ns flex-wrap justify-around mt5">
      
        <div class="relative w-100 w-30-l mb4 bg-white">
          <div class="relative w-100 mb4 bg-white nested-copy-line-height">
  <div class="bg-white mb3 pa4 gray overflow-hidden">
    <span class="f6 db">Posts</span>
    <h1 class="f3 near-black">
      <a href="/posts/automator-application-to-run-script-as-root-comments/" class="link black dim">
        Automator application to run script as root
      </a>
    </h1>
    <div class="nested-links f5 lh-copy nested-copy-line-height">
      <h4 id="heading"></h4>
<p><a href="http://rayleighwickfordlabour.org.uk" title="n.martin@rayleighwickfordlabour.org.uk">n.martin</a> - <!-- raw HTML omitted -->Dec 2, 2017<!-- raw HTML omitted --></p>
<p>Heyas - it looks like you might be using Jamf from the last screenshot (jamfhelper?). If you&rsquo;re running Jamf Pro 10, you could put the installer policy in Self Service and get a URL that opens Self Service and runs that policy automatically: <a href="http://docs.jamf.com/10.0.0/jamf-pro/administrator-guide/Making">http://docs.jamf.com/10.0.0/jamf-pro/administrator-guide/Making</a>_Items_Available_to_Users_in_Jamf_Self_Service_for_macOS.html There&rsquo;s a section on that page; Item URLs An AppleScript with: do shell script &ldquo;open &quot; might work (haven&rsquo;t tested but would be really interested).</p>
    </div>
    <a href="/posts/automator-application-to-run-script-as-root-comments/" class="ba b--moon-gray bg-light-gray br2 color-inherit dib f7 hover-bg-moon-gray link mt2 ph2 pv1">read more</a>
  </div>
</div>

        </div>
      
        <div class="relative w-100 w-30-l mb4 bg-white">
          <div class="relative w-100 mb4 bg-white nested-copy-line-height">
  <div class="bg-white mb3 pa4 gray overflow-hidden">
    <span class="f6 db">Posts</span>
    <h1 class="f3 near-black">
      <a href="/posts/automator-application-to-run-script-as-root/" class="link black dim">
        Automator application to run script as root
      </a>
    </h1>
    <div class="nested-links f5 lh-copy nested-copy-line-height">
      <p>I was recently asked to create a shortcut on our users&rsquo; Desktops to kick off the High Sierra install. We are caching the installer through our management system. In the past I have created a shortcut to the installer on their Desktop, but that required them to click through the many continue buttons. This method will use the startosinstall script from <a href="https://github.com/bp88/JSS-Scripts/blob/master/OS_Upgrade.sh">Slack member @bp</a> to start the install with minimal user interaction. I wrap that shell script (with the appropriate modifications for my environment) in an Automator application, but to have the script run as root, I call it with Run AppleScript using the <code>do shell script ... with administrator privileges</code> form. <img src="https://sneakypockets.wordpress.com/wp-content/uploads/2017/12/automatorinstaller.png" alt="AutomatorInstaller.png"> The full AppleScript is</p>
    </div>
    <a href="/posts/automator-application-to-run-script-as-root/" class="ba b--moon-gray bg-light-gray br2 color-inherit dib f7 hover-bg-moon-gray link mt2 ph2 pv1">read more</a>
  </div>
</div>

        </div>
      
        <div class="relative w-100 w-30-l mb4 bg-white">
          <div class="relative w-100 mb4 bg-white nested-copy-line-height">
  <div class="bg-white mb3 pa4 gray overflow-hidden">
    <span class="f6 db">Posts</span>
    <h1 class="f3 near-black">
      <a href="/posts/using-installer-choices-xml-to-modify-anyconnect-and-mcafee-deployments-comments/" class="link black dim">
        Using installer choices.xml to modify AnyConnect and McAfee deployments
      </a>
    </h1>
    <div class="nested-links f5 lh-copy nested-copy-line-height">
      <h4 id="heading"></h4>
<p><a href="http://www.rogers.com" title="scott.beach@rci.rogers.com">Scott Beach</a> - <!-- raw HTML omitted -->Oct 3, 2018<!-- raw HTML omitted --></p>
<p>I&rsquo;ve been looking for this information for exactly these two .pkgs! This is great. Thank very much for it. I&rsquo;ll work on it tomorrow! - Scott Rogers Communications MacAnalyst</p>
<!-- raw HTML omitted -->
<p>[…] showing how to deploy Cisco AnyConnect using Jamf Pro. As part of that documentation, HCS described how to create an installer choices XML file and then use it to create a custom Cisco AnyConnect installer […]</p>
    </div>
    <a href="/posts/using-installer-choices-xml-to-modify-anyconnect-and-mcafee-deployments-comments/" class="ba b--moon-gray bg-light-gray br2 color-inherit dib f7 hover-bg-moon-gray link mt2 ph2 pv1">read more</a>
  </div>
</div>

        </div>
      
        <div class="relative w-100 w-30-l mb4 bg-white">
          <div class="relative w-100 mb4 bg-white nested-copy-line-height">
  <div class="bg-white mb3 pa4 gray overflow-hidden">
    <span class="f6 db">Posts</span>
    <h1 class="f3 near-black">
      <a href="/posts/using-installer-choices-xml-to-modify-anyconnect-and-mcafee-deployments/" class="link black dim">
        Using installer choices.xml to modify AnyConnect and McAfee deployments
      </a>
    </h1>
    <div class="nested-links f5 lh-copy nested-copy-line-height">
      <p>[edit] I have written a follow up article explaining how to wrap a vendor package and custom choices.xml in a <a href="https://sneakypockets.wordpress.com/2020/03/17/creating-a-wrapper-package-for-a-choices-xml-file/">wrapper package</a>.[/edit] I have seen several posts on <a href="https://macadmins.herokuapp.com">MacAdmin Slack</a> asking for help deploying only components of big packages that the business wants or needs.  There are often several ways of handling this.  For example, from the McAfee ePO console, your admin can give you a Threat Prevention only installer instead of the full Endpoint Security package.  That is great if you can grab that yourself or the admin is helpful and able to get it for you.  This isn&rsquo;t always the case.  Another route is to install the full package and then uninstall the pieces that you don&rsquo;t want/need.  The Cisco AnyConnect Secure Mobility client installer does put uninstall scripts for each piece of the package in /opt/cisco/anyconnect/bin.  Both of these options can get your Macs to the end state you want, but they do have potential drawbacks/complications.  Using the Apple provided installer command line tool, we can see what options are available in these packages and then create a file to set which pieces we want.  This does take some work upfront, but we have all the tools we need.   To start we need an installer package that has choices.  We will focus on 2, Cisco&rsquo;s AnyConnect Secure Mobility Client 4.3.03086 and McAfee&rsquo;s Endpoint Security for Mac 10.2.1.  The choices show up in the GUI as selectable check boxes. [gallery ids=&ldquo;593,592&rdquo; type=&ldquo;rectangular&rdquo;] To see these choices from the command line and generate the information we need, we use the installer command with the <code>‑showChoicesXML</code> option and pass it the package we are interested in.  Depending on the package, we may also need to specify the target, so I generally always do.  Be careful with the target.  Some installers will behave differently if some or all of the software is already installed. Installing on a clean system (maybe a VM you can role back) is a good way to see the real default behavior. Notice in the Cisco installer picture above, VPN and WebSecurity are unchecked and grayed out.  That is because my target already has those pieces installed on it. Our command is: <code>installer ‑showChoicesXML ‑pkg /path/to/AnyConnect.pkg ‑target /</code> That will print a bunch of information to standard out (the terminal window), so I will often redirect it to a file for saving and easier reading/searching like so: <code>installer ‑showChoicesXML ‑pkg /path/to/AnyConnect.pkg ‑target / &gt; ~/Desktop/anyconnect_choices.xml</code> That will output something like:[gist]542c05e12abb931746cc9811e60fe32d[/gist] Notice the individual dictionaries:[gist]14ad94a01a22cb98a5de9f6f36448247[/gist] This is one of the choices in the package (Umbrella).  Notice that the choiceIsSelected key is set to 1.  This means that by default on this volume (the target from the command), this choice will be installed.  We want to tell the installer command to skip this choice so we want to set choiceIsSelected to 0.  To do that we will create our own xml file that has the values we want.  The keys that we need are the choiceIdentifier, choiceIsSelected, and whether we want the choice to install (set value to 1) or not install (set value to 0).  Our file needs to be valid XML, so we need the appropriate file header.  You can create a valid XML file with the built in defaults command but for this, we can just copy the skeleton of our choices.xml we output from installer.[gist]c7002bd6dba90b136ff48b7a5a3b08eb[/gist] Now we need to add a dictionary for each setting we want to set in this form:[gist]e157915f4e47ce2583eaea71b682cd6d[/gist] We need to match the choiceIdentifier values to the those in the output of the installer command.  This AnyConnect package is setup nicely for easy reading.  Not all packages are (more on that later).  Then we have our choiceAttribute key (the key we want to change from default) set to &lsquo;selected&rsquo; and finally what we want to set that attribute to in the attributeSetting key (in this case we are setting it to 0 so this choice doesn&rsquo;t install). We only need to add entries for things we want to change from the default. In this case the choices file specifies settings for all possible choices. Once we build up our file, we get something like:[gist]8a34f3b7741de31e969e09247b3c31d9[/gist] This file tells <code>installer</code> to install VPN and skip the rest. Now we are ready to test the package.  To first verify that things look like they will work, we can use the <code>‑showChoicesAfterApplyingChangesXML</code> option for installer and see what it will try to do. <code>installer ‑showChoicesAfterApplyingChangesXML /path/to/choicesForAnyConnect.xml ‑pkg /path/to/AnyConnect.pkg ‑target /</code> [gist]9f62ad9b678d20181f6365099c94169c[/gist]In this output we will see more than one entry for each choice.  In this output I have 3, enabled, visible, and selected.  Enabled means will the choice be allowed to be changed in the GUI and visible means will it even show up in the GUI.  We are only worried about selected as we aren&rsquo;t going to use the GUI.  So confirm that the choices we want to install have selected set to 1 and the choices we want to skip have selected set to 0. Once that all looks correct, we can actually deploy with <code>‑applyChoiceChangesXML</code>.  That looks like <code>installer ‑applyChoiceChangesXML /path/to/choicesForAnyConnect.xml ‑pkg /path/to/AnyConnect.pkg ‑target /</code> This can be packaged up for deployment through a management tool pretty easily.  Basically you want to put the default package and your choices.xml into the packages resources area and then have a post install script that runs the above command.  There is a lot more detail possible, but that might be another blog post. Cisco&rsquo;s AnyConnect Secure Mobility installer is pretty friendly when it comes to repackaging/making choices.  If we try to apply the above to the McAfee Endpoint Security 10.2.1 installer, we will see some additional complexity. <code>installer ‑showChoicesXML ‑pkg /path/to/McAfee_Endpoint_Security\ 10.2.1/1\ Source/McAfee-Endpoint-Security-for-Mac-10.2.1-RTW-standalone-2632.pkg ‑target /</code> [gist]6c976037049b701741deb01bce7c660d[/gist] Notice that the choiceIdentifier is the not so helpful installer_choice_5.  We can still see what the choice is by the choiceTitle, but now when we create our choices.xml, we need to be very careful about which choices we are selecting and which we are not.  Your end result will look something like: [gist]c4cb8ef55ce6e11b108fa6a51e48c385[/gist] In this file, installer_choice_5 is the Firewall and installer_choice_6 is Web Control. For this type of package it can be important to save the output of showChoicesXML as a reference for which choice is which. This is an example of only putting in dictionaries for the choices we want to change.  I would say this is probably not a best practice as different systems can end up with different defaults, but it can work.</p>
    </div>
    <a href="/posts/using-installer-choices-xml-to-modify-anyconnect-and-mcafee-deployments/" class="ba b--moon-gray bg-light-gray br2 color-inherit dib f7 hover-bg-moon-gray link mt2 ph2 pv1">read more</a>
  </div>
</div>

        </div>
      
        <div class="relative w-100 w-30-l mb4 bg-white">
          <div class="relative w-100 mb4 bg-white nested-copy-line-height">
  <div class="bg-white mb3 pa4 gray overflow-hidden">
    <span class="f6 db">Posts</span>
    <h1 class="f3 near-black">
      <a href="/posts/signing-installer-packages-with-automator-comments/" class="link black dim">
        Signing Installer Packages with Automator
      </a>
    </h1>
    <div class="nested-links f5 lh-copy nested-copy-line-height">
      <h4 id="heading"></h4>
<p><a href="%22developers@buildtestrun.com%22">mbonne</a> - <!-- raw HTML omitted -->Apr 5, 2019<!-- raw HTML omitted --></p>
<p>+1 automation services levelled up</p>
<!-- raw HTML omitted -->
<p>[…] is created, drag it to the Post-installation well, save your package, and build it. I then sign my packages with a certificate from my company’s Apple developer […]</p>
<!-- raw HTML omitted -->
    </div>
    <a href="/posts/signing-installer-packages-with-automator-comments/" class="ba b--moon-gray bg-light-gray br2 color-inherit dib f7 hover-bg-moon-gray link mt2 ph2 pv1">read more</a>
  </div>
</div>

        </div>
      
        <div class="relative w-100 w-30-l mb4 bg-white">
          <div class="relative w-100 mb4 bg-white nested-copy-line-height">
  <div class="bg-white mb3 pa4 gray overflow-hidden">
    <span class="f6 db">Posts</span>
    <h1 class="f3 near-black">
      <a href="/posts/signing-installer-packages-with-automator/" class="link black dim">
        Signing Installer Packages with Automator
      </a>
    </h1>
    <div class="nested-links f5 lh-copy nested-copy-line-height">
      <p>Apple packages (.pkgs) are opened by the GUI Installer.app or the command line installer command. If a package is unsigned and gets a quarantine flag (from being transferred over a network), the GUI Installer will refuse to run it.<img src="https://sneakypockets.wordpress.com/wp-content/uploads/2016/11/screen-shot-2016-11-02-at-3-07-35-pm.png" alt="Screen Shot 2016-11-02 at 3.07.35 PM.png"> We can get around that with a right-click -&gt; Open, but we shouldn&rsquo;t be training computer users to ignore security warnings like this. <img src="https://sneakypockets.wordpress.com/wp-content/uploads/2016/11/screen-shot-2016-11-04-at-4-49-33-pm.png" alt="Screen Shot 2016-11-04 at 4.49.33 PM.png"> If you are creating your own packages, and users or techs may run them manually, then you really should be signing them. Even if you are deploying them in a way that a person won&rsquo;t see a warning, signing packages can be very easy and provide a check that nothing changed since you created it. See below the break for how to easily automate signing packages. I use <a href="http://s.sudre.free.fr/Software/Packages/about.html">WhiteBox Packages</a> to create most of my packages. It has a built in feature to sign packages it builds, but recent versions have had some problems with it and when it works it still has to be set per package project. The Apple provided tool to sign our packages is <code>productsign</code>. This works, but to make things easier on myself, I have wrapped that up in an Automator application that I can use as a droplet. The basic format for using productsign is <code>productsign [options] --sign identity input-product-path output-product-path</code> Interestingly, the man page for productsign doesn&rsquo;t show any available options. So next we want to <code>--sign</code> using <code>identity</code>. This is our Developer ID Installer certificate from Apple&rsquo;s developer program. This does require a paid membership, but if you work for an organization supporting Macs, there is plenty of benefit to offset the $99 or $399/year (signing identities, early access to OS builds for testing, etc). To sign packages we need a Developer ID Installer (see <a href="https://developer.apple.com/library/content/documentation/IDEs/Conceptual/AppDistributionGuide/MaintainingCertificates/MaintainingCertificates.html#//apple_ref/doc/uid/TP40012582-CH31-SW6">Apple&rsquo;s documentation</a>) Once you have your Dev ID Installer certificate installed in your keychain, then we can get the appropriate reference for it. Open /Applications/Utilities/Keychain Access. Search for Developer ID and select the appropriate certificate. Then you can highlight and copy the name.  If you are a part of more than one developer program, select the &ldquo;right&rdquo; one here.  You can create several Automator applications if you want to have one for each ID.<img src="https://sneakypockets.wordpress.com/wp-content/uploads/2016/11/screen-shot-2016-11-02-at-3-25-14-pm.png" alt="Screen Shot 2016-11-02 at 3.25.14 PM.png"> So now we can write our command <code>productsign --sign 'Developer ID Installer: OrgName (Code)' in_pkg out_pkg</code>. For example <code>productsign --sign 'Developer ID Installer: OrgName (Code)' ~/Development/Unsigned.pkg ~/Development/Signed.pkg</code>. This will prompt to allow productsign access to your keychain. Say Allow or Always Allow.<code>$ productsign --sign 'Developer ID Installer: OrgName (Code)' ~/Desktop/Unsigned/build/Unsigned.pkg ~/Desktop/Unsigned/build/Signed.pkg productsign: using timestamp authority for signature productsign: signing product with identity &quot;Developer ID Installer: OrgName (Code)&quot; from keychain /Users/username/Library/Keychains/login.keychain-db productsign: adding certificate &quot;Developer ID Certification Authority&quot; productsign: adding certificate &quot;Apple Root CA&quot; productsign: Wrote signed product archive to /Users/username/Desktop/Unsigned/build/Signed.pkg</code>Now when we run the installer by double clicking it, the installer opens. Notice the lock in the upper right corner. Click the clock and we can examine the certificate chain back to Apple&rsquo;s Root.<img src="https://sneakypockets.wordpress.com/wp-content/uploads/2016/11/screen-shot-2016-11-02-at-3-29-14-pm1.png" alt="Screen Shot 2016-11-02 at 3.29.14 PM.png"> The idea when we started was to make this easy to do since we might need to sign a lot of packages over time. To automate this, open /Applications/Automator.app. Choose to create a New Document. Then choose Application for the type and click Choose.<img src="https://sneakypockets.wordpress.com/wp-content/uploads/2016/11/screen-shot-2016-11-02-at-3-31-43-pm.png" alt="Screen Shot 2016-11-02 at 3.31.43 PM.png"> Search for shell in the Actions name search field. Drag a run shell script action to the workflow.<img src="https://sneakypockets.wordpress.com/wp-content/uploads/2016/11/screen-shot-2016-11-02-at-3-32-11-pm.png" alt="Screen Shot 2016-11-02 at 3.32.11 PM.png"> First adjust the Pass input: pop up to as arguments.<img src="https://sneakypockets.wordpress.com/wp-content/uploads/2016/11/screen-shot-2016-11-02-at-3-33-00-pm.png" alt="Screen Shot 2016-11-02 at 3.33.00 PM.png"> That will fill in the template for us. Then enter our productsign command with some slight differences. The <code>--sign</code> and <code>identity</code> will be the same, but now for the input and output, we need to make this work with whatever is dropped on the application. The packages will be passed as arguments and the for loop will work on each one in turn. These will be assigned to the pkg variable, so that becomes our input file. Then for the output, I settled on packagename.signed.pkg to differentiate the output from the input. This <code>$(sed 's/.pkg$/.signed.pkg/g' &lt;&lt;&lt; $pkg)</code> will find the last &lsquo;.pkg&rsquo; in the filename and replace it with &lsquo;.signed.pkg&rsquo;, while keeping the name portion the same (see note at the end for how this works) .  Notice I also changed the <code>f</code> to <code>pkg</code> just to make it clear what the variable represents.```
for pkg in &ldquo;$@&rdquo;
do
productsign &ndash;sign &lsquo;Developer ID Installer: OrgName (Code)&rsquo; &ldquo;$pkg&rdquo; &ldquo;$(sed &rsquo;s/.pkg$/.signed.pkg/g&rsquo; &laquo;&lt; $pkg)&rdquo;
done</p>
    </div>
    <a href="/posts/signing-installer-packages-with-automator/" class="ba b--moon-gray bg-light-gray br2 color-inherit dib f7 hover-bg-moon-gray link mt2 ph2 pv1">read more</a>
  </div>
</div>

        </div>
      
        <div class="relative w-100 w-30-l mb4 bg-white">
          <div class="relative w-100 mb4 bg-white nested-copy-line-height">
  <div class="bg-white mb3 pa4 gray overflow-hidden">
    <span class="f6 db">Posts</span>
    <h1 class="f3 near-black">
      <a href="/posts/mounting-file-shares-based-on-ad-group-membership-using-enterprise-connect-comments/" class="link black dim">
        Mounting File Shares Based on AD Group Membership using Enterprise Connect
      </a>
    </h1>
    <div class="nested-links f5 lh-copy nested-copy-line-height">
      <h4 id="heading"></h4>
<p><a href="%22brinckmann@bevelo.de%22">tam</a> - <!-- raw HTML omitted -->Jan 3, 2018<!-- raw HTML omitted --></p>
<p>Setting mount_options and open_options to none under 10.13.3 didtn work for me..but thank you :) Python[50420:162669] -[OC_PythonString objectForKey:]: unrecognized selector sent to instance 0x7fd716e28a80 Traceback (most recent call last): File &ldquo;&rdquo;, line 38, in File &ldquo;&rdquo;, line 30, in mount_share ValueError: NSInvalidArgumentException - -[OC_PythonString objectForKey:]: unrecognized selector sent to instance 0x7fd716e28a80</p>
<!-- raw HTML omitted -->
<p>hmm&hellip; I guess I ended up doing it a bit differently in production. Does this work for you? def mount_share(share_path): # Mounts a share at /Volumes, returns the mount point or raises an error sh_url = CoreFoundation.CFURLCreateWithString(None, share_path, None) # Set UI to reduced interaction # open_options = {NetFS.kNAUIOptionKey: NetFS.kNAUIOptionNoUI} # Allow mounting sub-directories of root shares # mount_options = {NetFS.kNetFSAllowSubMountsKey: True} # Mount! result, output = NetFS.NetFSMountURLSync(sh_url, None, None, None, None, None, None) # Check if it worked if result != 0: raise Exception(&lsquo;Error mounting url &ldquo;%s&rdquo;: %s&rsquo; % (share_path, output)) # Return the mountpath return str(output[0])</p>
    </div>
    <a href="/posts/mounting-file-shares-based-on-ad-group-membership-using-enterprise-connect-comments/" class="ba b--moon-gray bg-light-gray br2 color-inherit dib f7 hover-bg-moon-gray link mt2 ph2 pv1">read more</a>
  </div>
</div>

        </div>
      
        <div class="relative w-100 w-30-l mb4 bg-white">
          <div class="relative w-100 mb4 bg-white nested-copy-line-height">
  <div class="bg-white mb3 pa4 gray overflow-hidden">
    <span class="f6 db">Posts</span>
    <h1 class="f3 near-black">
      <a href="/posts/mounting-file-shares-based-on-ad-group-membership-using-enterprise-connect/" class="link black dim">
        Mounting File Shares Based on AD Group Membership using Enterprise Connect
      </a>
    </h1>
    <div class="nested-links f5 lh-copy nested-copy-line-height">
      <p>[edit] Apple changed something in macOS 10.13 High Sierra. The mount_share() function in the below python needs to be changed to set the open_options and mount_options to &lsquo;None&rsquo;. This can be done like<code>def mount\_share(share\_path): # Mounts a share at /Volumes, returns the mount point or raises an error sh\_url = CoreFoundation.CFURLCreateWithString(None, share\_path, None) # Set UI to reduced interaction #open\_options  = {NetFS.kNAUIOptionKey: NetFS.kNAUIOptionNoUI} # Allow mounting sub-directories of root shares #mount\_options = {NetFS.kNetFSAllowSubMountsKey: True} # Mount! result, output = NetFS.NetFSMountURLSync(sh\_url, None, None, None, None, None, None) # Check if it worked if result != 0: raise Exception('Error mounting url &quot;%s&quot;: %s' % (share\_path, output)) # Return the mountpath return str(output\[0\])</code>[/edit] In a <a href="https://sneakypockets.wordpress.com/2016/09/22/using-ldapsearch-to-get-ad-data/">previous post</a>, I discussed using <code>ldapsearch</code> to look up user data from AD.  In this post we will use the user&rsquo;s memberOf attribute to mount the appropriate file share. Some background on my use case for this.  The company I work for has ~15,000 Windows computers in use bound to AD.  When a user logs in, a GPO runs a batch file hosted on the domain controller&rsquo;s file share.  The batch file is basically a large case statement<code>if in group A; then     mount shares X and Y if in group B; then     mount share Z</code>I wanted to provide our Mac users with a similar experience.  Read how below the break. Our Macs are not bound to Active Directory and we have historically had password confusion issues with network vs local passwords and keychain sync issues.  To help this we have setup Apple&rsquo;s excellent <a href="https://jamfnation.jamfsoftware.com/discussion.html?id=17757">Enterprise Connect</a> to help with that. When a Mac user is logged in and is on a network that can connect to our domain controllers (internal, VPN, etc), Enterprise Connect automatically retrieves a Kerberos Ticket Granting Ticket for the user and, optionally, confirms that the local password is in sync with the user&rsquo;s AD password and prompts the user to fix things if necessary.  Enterprise Connect can also mount file shares including the user&rsquo;s home folder.  This is handled on a per user basis or by profile.  This works great if the user wants to mount a share they use, but it doesn&rsquo;t scale well across many locations and OUs. One of the other benefits of Enterprise Connect is that it can run scripts based on a couple of triggers including a successful connection (i.e. the Mac is on the right network and a valid TGT has been granted).  Note that Enterprise Connect can only run shell scripts this way. The script to run can be configured in the preference file or via profile with the key/value pair:<code>connectionCompletedScriptPath /Library/Scripts/LogonFileShareMounter.wrapper.sh</code>This script is stored locally on the client system and is what calls the script that will do the actual mounting.  Before that though, we first make sure that we have the current version of the mounting script by checking an embedded serial number (similar to how DNS primary/secondaries work).  The master copy of the mounting script is hosted on the same share as the Windows batch file.  This way it can be updated whenever the Windows version is.  As long as the serial number is updated, the Mac clients will get the updated version next time they successfully connect with Enterprise Connect. <a href="https://gist.github.com/ehemmete/618c96dc364d8a40723e30692617d2a8">https://gist.github.com/ehemmete/618c96dc364d8a40723e30692617d2a8</a> The script starts by creating a directory if necessary and then mounting the file share where the master script is kept.  The <code>mount_smbfs</code> line authenticates to the share with the Kerberos TGT  from Enterprise Connect.  Then as long as the master script can be found, the local serial is compared to the remote version.  If the remote is newer, it is copied in place of the local copy.  Then the share is unmounted and the local copy of the script is run. <a href="https://gist.github.com/ehemmete/2f893815bd03d96d89855feb4e9b7237">https://gist.github.com/ehemmete/2f893815bd03d96d89855feb4e9b7237</a> This script starts with the serial number that is compared against the master copy.  Then the part between the ### lines comes straight from MacAdmin Slack member and frequent gist&rsquo;er Froger/pudquick/MikeyMikey.  His <a href="https://gist.github.com/pudquick/1362a8908be01e23041d">gist</a> is referenced in the script and provides a python function for mounting network shares easily and in such as way that the system treats them the same as the Connect to Server dialog box. Then we get the user&rsquo;s local account name, which in my environment is the same as their Active Directory name, and use <code>ldapsearch</code> to find their group memberships.  Next we need to clean up the output.  At the end we have an array of names of the groups this user is a member of.  Now we start a case-like statement similar to the Window counter part.```
if &lsquo;Group1&rsquo; in groups:
mount_share(&lsquo;smb://server.my.domain.com/share&rsquo;)
mount_share(&lsquo;smb://server2.my.domain.com/share2&rsquo;)
if &lsquo;Group2&rsquo; in groups:
mount_share(&lsquo;smb://server3.my.domain.com/share&rsquo;)
etc&hellip;</p>
    </div>
    <a href="/posts/mounting-file-shares-based-on-ad-group-membership-using-enterprise-connect/" class="ba b--moon-gray bg-light-gray br2 color-inherit dib f7 hover-bg-moon-gray link mt2 ph2 pv1">read more</a>
  </div>
</div>

        </div>
      
        <div class="relative w-100 w-30-l mb4 bg-white">
          <div class="relative w-100 mb4 bg-white nested-copy-line-height">
  <div class="bg-white mb3 pa4 gray overflow-hidden">
    <span class="f6 db">Posts</span>
    <h1 class="f3 near-black">
      <a href="/posts/using-ldapsearch-to-get-ad-data-comments/" class="link black dim">
        Using ldapsearch to get AD data
      </a>
    </h1>
    <div class="nested-links f5 lh-copy nested-copy-line-height">
      <h4 id="heading"></h4>
<p><a href="https://sneakypockets.wordpress.com/2016/09/26/mounting-file-shares-based-on-ad-group-membership-using-enterprise-connect/" title="">Mounting File Shares Based on AD Group Membership using Enterprise Connect | My Thoughts</a> - <!-- raw HTML omitted -->Sep 1, 2016<!-- raw HTML omitted --></p>
<p>[…] a previous post, I discussed using ldapsearch to look up user data from AD.  In this post we will use the […]</p>
<!-- raw HTML omitted -->
    </div>
    <a href="/posts/using-ldapsearch-to-get-ad-data-comments/" class="ba b--moon-gray bg-light-gray br2 color-inherit dib f7 hover-bg-moon-gray link mt2 ph2 pv1">read more</a>
  </div>
</div>

        </div>
      
        <div class="relative w-100 w-30-l mb4 bg-white">
          <div class="relative w-100 mb4 bg-white nested-copy-line-height">
  <div class="bg-white mb3 pa4 gray overflow-hidden">
    <span class="f6 db">Posts</span>
    <h1 class="f3 near-black">
      <a href="/posts/using-ldapsearch-to-get-ad-data/" class="link black dim">
        Using ldapsearch to get AD data
      </a>
    </h1>
    <div class="nested-links f5 lh-copy nested-copy-line-height">
      <p>It has been common for Macs to be bound to Active Directory for a variety of reasons.  Recently, the trend has been to move away from binding due to password/lock out issues, the rise of cloud based services, and SSO options that are more comprehensive of the services users need. With the move away from binding, one thing we lose is the ability to look up user and group data with <code>dscl</code>. Here is a decent primer on <code>dscl</code>: http://www.macos.utah.edu/documentation/authentication/dscl.html (just replace every instance of netinfo with dslocal in your mind). With this move we need another tool to query for information and <code>ldapsearch</code> can do this for us.  There are a lot of ways to use <code>ldapsearch</code> depending on your end goal.  This post will discuss getting user data out of an Active Directory server.  In a future post I hope to explain how I am using this to mount the appropriate file shares for users based on their group membership. The basic format for ldapsearch is to tell it where to search, with what account to search, what to search for, and what data to return from any matches.  A common search I use is:<code>ldapsearch -LLL -H &quot;ldap://${adURL}&quot; -b &quot;${searchbase}&quot; &quot;(&amp;(objectCategory=Person)(objectClass=User)(sAMAccountName=$endUser))&quot; memberOf</code>We start with the command, of course.  Then the <code>-LLL</code> tells the command to limit the output.  I find this gives less output to clean out before I get what I want.  The man page says:<code>**\-L**     Search  results  are  display in LDAP Data Interchange Format detailed in **ldif**(5).  A single **\-L** restricts the output to LDIFv1. A second **\-L** disables comments.  A third **\-L** disables printing of the LDIF version.  The defaultis to use an extended version of LDIF.</code>Then we need to tell ldapsearch where to search.  There are a few parts to this.  The first is the <code>-H</code> option with an ldapuri which will often be the DNS name of the domain controller you want to search on in the form &ldquo;ldap://my.domain.com&rdquo;.  (This can generally be found with <code>host -t SRV _ldap._tcp.my.domain.com</code>).  If you have multiple DCs, you can search more than one, but I normally pick a close one to search.  Then <code>-b</code> specifies the search base to start the search from.  I use the root of the LDAP structure, but if you know where your data is going to be you can be more specific.  This will be in the form <code>&quot;dc=my,dc=domain,dc=com&quot;</code> or <code>&quot;OU=Computers,dc=my,dc=domain,dc=com&quot;</code>. Next we need to tell ldapsearch who to search as.  In my command above, I don&rsquo;t make it explicit, but the default is to check for a kerberos ticket granting ticket and use that for authentication.  This works nicely for scripting since there is no password to worry about, but you do need to be sure there will be a TGT when the script/command runs.  Another form of ldapsearch command would be:<code>ldapsearch -LLL -x -H &quot;ldaps://$adURL&quot; -D &quot;${techNameTest}@my.domain.com&quot; -w &quot;$techPW&quot; -b &quot;${searchbase}&quot; &quot;(&amp;(objectCategory=Person)(objectClass=User)(sAMAccountName=$endUser))&quot; memberOf</code>In this search we first tell ldapsearch to use simple (username/password) authentication with the <code>-x</code> option.  Then specify who to search as with <code>-D</code> and the full form should be <code>&quot;user@domain&quot;</code> or <code>&quot;domain\user&quot;</code>.  Then the <code>-w</code> is used to put the password inline with the command.  If there are special characters in the password be sure to wrap it in single quotes; <code>'pa$$W0rd!'</code>.  For one off searches, you can use <code>-W</code> to have the command prompt for the password.  <strong>Also note,when using password base authentication, we should really use ldaps:// in the <code>-H</code> option.  Otherwise the password will be sent across the network in the clear.<img src="https://sneakypockets.wordpress.com/wp-content/uploads/2016/09/screen-shot-2016-09-22-at-10-46-17-am1.png" alt="Screen Shot 2016-09-22 at 10.46.17 AM.png">With kerberos authentication the password is not sent across the network at all.</strong> Next we specify what to search for.  In this case I am searching for a user&rsquo;s account, but it could be in many different locations.  We can string filters together using the &ldquo;(&amp;(filter)(filter)(filter)&hellip;)&rdquo; format.  The filters can include a wide range of things.  I am limiting the search based on <code>objectCategory=Person</code>, <code>objectClass=User</code>, and <code>sAMAccountName=first.last</code>.  It turns out I can get away with just using the sAMAccountName if I know exactly who I am looking for.  If we only need one filter, we can use the form &ldquo;(filter)&rdquo;, i.e. <code>&quot;(sAMAccountName=first.last)&quot;</code>. Lastly we tell <code>ldapsearch</code> what data we want back.  This is optional if you want the entire record, but if we just need one piece it is very useful to get that one thing returned.  In this case I am requesting just the <code>memberOf</code> values from the account.  This will tell me the groups this user is a member of. If we put this all together we can get something like this (note you can limit the output further with <code>2&gt;/dev/null</code> , which will redirect the authentication messages which are sent to stderr): [code language=&ldquo;bash&rdquo;]$ldapsearch -LLL -H &ldquo;ldap://dc.my.domain.com&rdquo; -b &ldquo;dc=my,dc=domain,dc=com&rdquo; &ldquo;(sAMAccountName=last)&rdquo; memberOf SASL/GSSAPI authentication started SASL username: <a href="mailto:tech.id@MY.DOMAIN.COM">tech.id@MY.DOMAIN.COM</a> SASL SSF: 112 SASL data security layer installed. dn: CN=Tech.ID,OU=CO,OU=Users,OU=US,DC=MY,DC=DOMAIN,DC=com memberOf: CN=AM IT Infrastructure Group,OU=Distribution Lists,OU=Exchange,OU=US,DC=MY,DC=DOMAIN,DC=COM memberOf: CN=AM AON IT,OU=Distribution Lists,OU=Exchange,OU=US,DC=MY,DC=DOMAIN,DC=COM memberOf: CN=WebReports_ReadOnly,OU=Groups,OU=US,DC=MY,DC=DOMAIN,DC=COM memberOf: CN=IT - MaaS360 AM Compliance Block,OU=Distribution Lists,OU=Exchange,OU=US,DC=MY,DC=DOMAIN,DC=COM memberOf: CN=AM MFA VPN,OU=Distribution Lists,OU=Exchange,OU=US,DC=MY,DC=DOMAIN,DC=COM memberOf: CN=Configuration Management,OU=Distribution Lists,OU=Exchange,OU=US,DC=MY,DC=DOMAIN,DC=COM memberOf: CN=IT - Lync Users in AM,OU=Distribution Lists,OU=Exchange,OU=US,DC=AM,DC=DOMAIN,DC=COM memberOf: CN=IT - Cisco usCUCMCluster02 Users,OU=Distribution Lists,OU=Exchange,OU=US,DC=MY,DC=DOMAIN,DC=COM memberOf: CN=L\#Contractor,OU=Groups,OU=US,DC=MY,DC=DOMAIN,DC=COM memberOf: CN=SCCDUsers-AM,OU=Global,DC=MY,DC=DOMAIN,DC=COM memberOf: CN=IT - Exchange 365 Users in AM,OU=Distribution Lists,OU=Exchange,OU=US,DC=MY,DC=DOMAIN,DC=COM memberOf: CN=AON IT Contractors (US),OU=Distribution Lists,OU=Exchange,OU=US,DC=AM,DC=DOMAIN,DC=COM memberOf: CN=Americas IT Consultants,OU=Distribution Lists,OU=Exchange,OU=US,DC=AM,DC=DOMAIN,DC=COM # refldap://DomainDnsZones.AM.DOMAIN.com/DC=DomainDnsZones,DC=MY,DC=DOMAIN,DC=com [/code]</p>
    </div>
    <a href="/posts/using-ldapsearch-to-get-ad-data/" class="ba b--moon-gray bg-light-gray br2 color-inherit dib f7 hover-bg-moon-gray link mt2 ph2 pv1">read more</a>
  </div>
</div>

        </div>
      
    </section>
    <ul class="pagination pagination-default">
      <li class="page-item">
        <a href="/posts/" aria-label="First" class="page-link" role="button"><span aria-hidden="true">&laquo;&laquo;</span></a>
      </li>
      <li class="page-item">
        <a href="/posts/page/2/" aria-label="Previous" class="page-link" role="button"><span aria-hidden="true">&laquo;</span></a>
      </li>
      <li class="page-item">
        <a href="/posts/" aria-label="Page 1" class="page-link" role="button">1</a>
      </li>
      <li class="page-item">
        <a href="/posts/page/2/" aria-label="Page 2" class="page-link" role="button">2</a>
      </li>
      <li class="page-item active">
        <a aria-current="page" aria-label="Page 3" class="page-link" role="button">3</a>
      </li>
      <li class="page-item">
        <a href="/posts/page/4/" aria-label="Page 4" class="page-link" role="button">4</a>
      </li>
      <li class="page-item">
        <a href="/posts/page/5/" aria-label="Page 5" class="page-link" role="button">5</a>
      </li>
      <li class="page-item">
        <a href="/posts/page/4/" aria-label="Next" class="page-link" role="button"><span aria-hidden="true">&raquo;</span></a>
      </li>
      <li class="page-item">
        <a href="/posts/page/5/" aria-label="Last" class="page-link" role="button"><span aria-hidden="true">&raquo;&raquo;</span></a>
      </li>
    </ul></article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="http://localhost:1313/" >
    &copy;  Eric Hemmeter 2024 
  </a>
    <div>
<div class="ananke-socials">
  
</div>
</div>
  </div>
</footer>

  </body>
</html>
