<!DOCTYPE html>
<html lang="en-us">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Using ldapsearch to get AD data | My Thoughts</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="It has been common for Macs to be bound to Active Directory for a variety of reasons.  Recently, the trend has been to move away from binding due to password/lock out issues, the rise of cloud based services, and SSO options that are more comprehensive of the services users need. With the move away from binding, one thing we lose is the ability to look up user and group data with dscl. Here is a decent primer on dscl: http://www.macos.utah.edu/documentation/authentication/dscl.html (just replace every instance of netinfo with dslocal in your mind). With this move we need another tool to query for information and ldapsearch can do this for us.  There are a lot of ways to use ldapsearch depending on your end goal.  This post will discuss getting user data out of an Active Directory server.  In a future post I hope to explain how I am using this to mount the appropriate file shares for users based on their group membership. The basic format for ldapsearch is to tell it where to search, with what account to search, what to search for, and what data to return from any matches.  A common search I use is:ldapsearch -LLL -H &quot;ldap://${adURL}&quot; -b &quot;${searchbase}&quot; &quot;(&amp;(objectCategory=Person)(objectClass=User)(sAMAccountName=$endUser))&quot; memberOfWe start with the command, of course.  Then the -LLL tells the command to limit the output.  I find this gives less output to clean out before I get what I want.  The man page says:**\-L**     Search  results  are  display in LDAP Data Interchange Format detailed in **ldif**(5).  A single **\-L** restricts the output to LDIFv1. A second **\-L** disables comments.  A third **\-L** disables printing of the LDIF version.  The defaultis to use an extended version of LDIF.Then we need to tell ldapsearch where to search.  There are a few parts to this.  The first is the -H option with an ldapuri which will often be the DNS name of the domain controller you want to search on in the form &ldquo;ldap://my.domain.com&rdquo;.  (This can generally be found with host -t SRV _ldap._tcp.my.domain.com).  If you have multiple DCs, you can search more than one, but I normally pick a close one to search.  Then -b specifies the search base to start the search from.  I use the root of the LDAP structure, but if you know where your data is going to be you can be more specific.  This will be in the form &quot;dc=my,dc=domain,dc=com&quot; or &quot;OU=Computers,dc=my,dc=domain,dc=com&quot;. Next we need to tell ldapsearch who to search as.  In my command above, I don&rsquo;t make it explicit, but the default is to check for a kerberos ticket granting ticket and use that for authentication.  This works nicely for scripting since there is no password to worry about, but you do need to be sure there will be a TGT when the script/command runs.  Another form of ldapsearch command would be:ldapsearch -LLL -x -H &quot;ldaps://$adURL&quot; -D &quot;${techNameTest}@my.domain.com&quot; -w &quot;$techPW&quot; -b &quot;${searchbase}&quot; &quot;(&amp;(objectCategory=Person)(objectClass=User)(sAMAccountName=$endUser))&quot; memberOfIn this search we first tell ldapsearch to use simple (username/password) authentication with the -x option.  Then specify who to search as with -D and the full form should be &quot;user@domain&quot; or &quot;domain\user&quot;.  Then the -w is used to put the password inline with the command.  If there are special characters in the password be sure to wrap it in single quotes; &#39;pa$$W0rd!&#39;.  For one off searches, you can use -W to have the command prompt for the password.  Also note,when using password base authentication, we should really use ldaps:// in the -H option.  Otherwise the password will be sent across the network in the clear.With kerberos authentication the password is not sent across the network at all. Next we specify what to search for.  In this case I am searching for a user&rsquo;s account, but it could be in many different locations.  We can string filters together using the &ldquo;(&amp;(filter)(filter)(filter)&hellip;)&rdquo; format.  The filters can include a wide range of things.  I am limiting the search based on objectCategory=Person, objectClass=User, and sAMAccountName=first.last.  It turns out I can get away with just using the sAMAccountName if I know exactly who I am looking for.  If we only need one filter, we can use the form &ldquo;(filter)&rdquo;, i.e. &quot;(sAMAccountName=first.last)&quot;. Lastly we tell ldapsearch what data we want back.  This is optional if you want the entire record, but if we just need one piece it is very useful to get that one thing returned.  In this case I am requesting just the memberOf values from the account.  This will tell me the groups this user is a member of. If we put this all together we can get something like this (note you can limit the output further with 2&gt;/dev/null , which will redirect the authentication messages which are sent to stderr): [code language=&ldquo;bash&rdquo;]$ldapsearch -LLL -H &ldquo;ldap://dc.my.domain.com&rdquo; -b &ldquo;dc=my,dc=domain,dc=com&rdquo; &ldquo;(sAMAccountName=last)&rdquo; memberOf SASL/GSSAPI authentication started SASL username: tech.id@MY.DOMAIN.COM SASL SSF: 112 SASL data security layer installed. dn: CN=Tech.ID,OU=CO,OU=Users,OU=US,DC=MY,DC=DOMAIN,DC=com memberOf: CN=AM IT Infrastructure Group,OU=Distribution Lists,OU=Exchange,OU=US,DC=MY,DC=DOMAIN,DC=COM memberOf: CN=AM AON IT,OU=Distribution Lists,OU=Exchange,OU=US,DC=MY,DC=DOMAIN,DC=COM memberOf: CN=WebReports_ReadOnly,OU=Groups,OU=US,DC=MY,DC=DOMAIN,DC=COM memberOf: CN=IT - MaaS360 AM Compliance Block,OU=Distribution Lists,OU=Exchange,OU=US,DC=MY,DC=DOMAIN,DC=COM memberOf: CN=AM MFA VPN,OU=Distribution Lists,OU=Exchange,OU=US,DC=MY,DC=DOMAIN,DC=COM memberOf: CN=Configuration Management,OU=Distribution Lists,OU=Exchange,OU=US,DC=MY,DC=DOMAIN,DC=COM memberOf: CN=IT - Lync Users in AM,OU=Distribution Lists,OU=Exchange,OU=US,DC=AM,DC=DOMAIN,DC=COM memberOf: CN=IT - Cisco usCUCMCluster02 Users,OU=Distribution Lists,OU=Exchange,OU=US,DC=MY,DC=DOMAIN,DC=COM memberOf: CN=L\#Contractor,OU=Groups,OU=US,DC=MY,DC=DOMAIN,DC=COM memberOf: CN=SCCDUsers-AM,OU=Global,DC=MY,DC=DOMAIN,DC=COM memberOf: CN=IT - Exchange 365 Users in AM,OU=Distribution Lists,OU=Exchange,OU=US,DC=MY,DC=DOMAIN,DC=COM memberOf: CN=AON IT Contractors (US),OU=Distribution Lists,OU=Exchange,OU=US,DC=AM,DC=DOMAIN,DC=COM memberOf: CN=Americas IT Consultants,OU=Distribution Lists,OU=Exchange,OU=US,DC=AM,DC=DOMAIN,DC=COM # refldap://DomainDnsZones.AM.DOMAIN.com/DC=DomainDnsZones,DC=MY,DC=DOMAIN,DC=com [/code]">
    <meta name="generator" content="Hugo 0.135.0">
    
    
    
    
      <meta name="robots" content="noindex, nofollow">
    
    

    
<link rel="stylesheet" href="/ananke/css/main.min.css" >



    

    
      

    

    

    
      <link rel="canonical" href="http://localhost:1313/posts/using-ldapsearch-to-get-ad-data/">
    

    <meta property="og:url" content="http://localhost:1313/posts/using-ldapsearch-to-get-ad-data/">
  <meta property="og:site_name" content="My Thoughts">
  <meta property="og:title" content="Using ldapsearch to get AD data">
  <meta property="og:description" content="It has been common for Macs to be bound to Active Directory for a variety of reasons. Recently, the trend has been to move away from binding due to password/lock out issues, the rise of cloud based services, and SSO options that are more comprehensive of the services users need. With the move away from binding, one thing we lose is the ability to look up user and group data with dscl. Here is a decent primer on dscl: http://www.macos.utah.edu/documentation/authentication/dscl.html (just replace every instance of netinfo with dslocal in your mind). With this move we need another tool to query for information and ldapsearch can do this for us. There are a lot of ways to use ldapsearch depending on your end goal. This post will discuss getting user data out of an Active Directory server. In a future post I hope to explain how I am using this to mount the appropriate file shares for users based on their group membership. The basic format for ldapsearch is to tell it where to search, with what account to search, what to search for, and what data to return from any matches. A common search I use is:ldapsearch -LLL -H &#34;ldap://${adURL}&#34; -b &#34;${searchbase}&#34; &#34;(&amp;(objectCategory=Person)(objectClass=User)(sAMAccountName=$endUser))&#34; memberOfWe start with the command, of course. Then the -LLL tells the command to limit the output. I find this gives less output to clean out before I get what I want. The man page says:**\-L** Search results are display in LDAP Data Interchange Format detailed in **ldif**(5). A single **\-L** restricts the output to LDIFv1. A second **\-L** disables comments. A third **\-L** disables printing of the LDIF version. The defaultis to use an extended version of LDIF.Then we need to tell ldapsearch where to search. There are a few parts to this. The first is the -H option with an ldapuri which will often be the DNS name of the domain controller you want to search on in the form “ldap://my.domain.com”. (This can generally be found with host -t SRV _ldap._tcp.my.domain.com). If you have multiple DCs, you can search more than one, but I normally pick a close one to search. Then -b specifies the search base to start the search from. I use the root of the LDAP structure, but if you know where your data is going to be you can be more specific. This will be in the form &#34;dc=my,dc=domain,dc=com&#34; or &#34;OU=Computers,dc=my,dc=domain,dc=com&#34;. Next we need to tell ldapsearch who to search as. In my command above, I don’t make it explicit, but the default is to check for a kerberos ticket granting ticket and use that for authentication. This works nicely for scripting since there is no password to worry about, but you do need to be sure there will be a TGT when the script/command runs. Another form of ldapsearch command would be:ldapsearch -LLL -x -H &#34;ldaps://$adURL&#34; -D &#34;${techNameTest}@my.domain.com&#34; -w &#34;$techPW&#34; -b &#34;${searchbase}&#34; &#34;(&amp;(objectCategory=Person)(objectClass=User)(sAMAccountName=$endUser))&#34; memberOfIn this search we first tell ldapsearch to use simple (username/password) authentication with the -x option. Then specify who to search as with -D and the full form should be &#34;user@domain&#34; or &#34;domain\user&#34;. Then the -w is used to put the password inline with the command. If there are special characters in the password be sure to wrap it in single quotes; &#39;pa$$W0rd!&#39;. For one off searches, you can use -W to have the command prompt for the password. Also note,when using password base authentication, we should really use ldaps:// in the -H option. Otherwise the password will be sent across the network in the clear.With kerberos authentication the password is not sent across the network at all. Next we specify what to search for. In this case I am searching for a user’s account, but it could be in many different locations. We can string filters together using the “(&amp;(filter)(filter)(filter)…)” format. The filters can include a wide range of things. I am limiting the search based on objectCategory=Person, objectClass=User, and sAMAccountName=first.last. It turns out I can get away with just using the sAMAccountName if I know exactly who I am looking for. If we only need one filter, we can use the form “(filter)”, i.e. &#34;(sAMAccountName=first.last)&#34;. Lastly we tell ldapsearch what data we want back. This is optional if you want the entire record, but if we just need one piece it is very useful to get that one thing returned. In this case I am requesting just the memberOf values from the account. This will tell me the groups this user is a member of. If we put this all together we can get something like this (note you can limit the output further with 2&gt;/dev/null , which will redirect the authentication messages which are sent to stderr): [code language=“bash”]$ldapsearch -LLL -H “ldap://dc.my.domain.com” -b “dc=my,dc=domain,dc=com” “(sAMAccountName=last)” memberOf SASL/GSSAPI authentication started SASL username: tech.id@MY.DOMAIN.COM SASL SSF: 112 SASL data security layer installed. dn: CN=Tech.ID,OU=CO,OU=Users,OU=US,DC=MY,DC=DOMAIN,DC=com memberOf: CN=AM IT Infrastructure Group,OU=Distribution Lists,OU=Exchange,OU=US,DC=MY,DC=DOMAIN,DC=COM memberOf: CN=AM AON IT,OU=Distribution Lists,OU=Exchange,OU=US,DC=MY,DC=DOMAIN,DC=COM memberOf: CN=WebReports_ReadOnly,OU=Groups,OU=US,DC=MY,DC=DOMAIN,DC=COM memberOf: CN=IT - MaaS360 AM Compliance Block,OU=Distribution Lists,OU=Exchange,OU=US,DC=MY,DC=DOMAIN,DC=COM memberOf: CN=AM MFA VPN,OU=Distribution Lists,OU=Exchange,OU=US,DC=MY,DC=DOMAIN,DC=COM memberOf: CN=Configuration Management,OU=Distribution Lists,OU=Exchange,OU=US,DC=MY,DC=DOMAIN,DC=COM memberOf: CN=IT - Lync Users in AM,OU=Distribution Lists,OU=Exchange,OU=US,DC=AM,DC=DOMAIN,DC=COM memberOf: CN=IT - Cisco usCUCMCluster02 Users,OU=Distribution Lists,OU=Exchange,OU=US,DC=MY,DC=DOMAIN,DC=COM memberOf: CN=L\#Contractor,OU=Groups,OU=US,DC=MY,DC=DOMAIN,DC=COM memberOf: CN=SCCDUsers-AM,OU=Global,DC=MY,DC=DOMAIN,DC=COM memberOf: CN=IT - Exchange 365 Users in AM,OU=Distribution Lists,OU=Exchange,OU=US,DC=MY,DC=DOMAIN,DC=COM memberOf: CN=AON IT Contractors (US),OU=Distribution Lists,OU=Exchange,OU=US,DC=AM,DC=DOMAIN,DC=COM memberOf: CN=Americas IT Consultants,OU=Distribution Lists,OU=Exchange,OU=US,DC=AM,DC=DOMAIN,DC=COM # refldap://DomainDnsZones.AM.DOMAIN.com/DC=DomainDnsZones,DC=MY,DC=DOMAIN,DC=com [/code]">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2016-09-22T17:31:02+00:00">
    <meta property="article:modified_time" content="2016-09-22T17:31:02+00:00">
    <meta property="article:tag" content="OS X General">
    <meta property="article:tag" content="Shell Script">

  <meta itemprop="name" content="Using ldapsearch to get AD data">
  <meta itemprop="description" content="It has been common for Macs to be bound to Active Directory for a variety of reasons. Recently, the trend has been to move away from binding due to password/lock out issues, the rise of cloud based services, and SSO options that are more comprehensive of the services users need. With the move away from binding, one thing we lose is the ability to look up user and group data with dscl. Here is a decent primer on dscl: http://www.macos.utah.edu/documentation/authentication/dscl.html (just replace every instance of netinfo with dslocal in your mind). With this move we need another tool to query for information and ldapsearch can do this for us. There are a lot of ways to use ldapsearch depending on your end goal. This post will discuss getting user data out of an Active Directory server. In a future post I hope to explain how I am using this to mount the appropriate file shares for users based on their group membership. The basic format for ldapsearch is to tell it where to search, with what account to search, what to search for, and what data to return from any matches. A common search I use is:ldapsearch -LLL -H &#34;ldap://${adURL}&#34; -b &#34;${searchbase}&#34; &#34;(&amp;(objectCategory=Person)(objectClass=User)(sAMAccountName=$endUser))&#34; memberOfWe start with the command, of course. Then the -LLL tells the command to limit the output. I find this gives less output to clean out before I get what I want. The man page says:**\-L** Search results are display in LDAP Data Interchange Format detailed in **ldif**(5). A single **\-L** restricts the output to LDIFv1. A second **\-L** disables comments. A third **\-L** disables printing of the LDIF version. The defaultis to use an extended version of LDIF.Then we need to tell ldapsearch where to search. There are a few parts to this. The first is the -H option with an ldapuri which will often be the DNS name of the domain controller you want to search on in the form “ldap://my.domain.com”. (This can generally be found with host -t SRV _ldap._tcp.my.domain.com). If you have multiple DCs, you can search more than one, but I normally pick a close one to search. Then -b specifies the search base to start the search from. I use the root of the LDAP structure, but if you know where your data is going to be you can be more specific. This will be in the form &#34;dc=my,dc=domain,dc=com&#34; or &#34;OU=Computers,dc=my,dc=domain,dc=com&#34;. Next we need to tell ldapsearch who to search as. In my command above, I don’t make it explicit, but the default is to check for a kerberos ticket granting ticket and use that for authentication. This works nicely for scripting since there is no password to worry about, but you do need to be sure there will be a TGT when the script/command runs. Another form of ldapsearch command would be:ldapsearch -LLL -x -H &#34;ldaps://$adURL&#34; -D &#34;${techNameTest}@my.domain.com&#34; -w &#34;$techPW&#34; -b &#34;${searchbase}&#34; &#34;(&amp;(objectCategory=Person)(objectClass=User)(sAMAccountName=$endUser))&#34; memberOfIn this search we first tell ldapsearch to use simple (username/password) authentication with the -x option. Then specify who to search as with -D and the full form should be &#34;user@domain&#34; or &#34;domain\user&#34;. Then the -w is used to put the password inline with the command. If there are special characters in the password be sure to wrap it in single quotes; &#39;pa$$W0rd!&#39;. For one off searches, you can use -W to have the command prompt for the password. Also note,when using password base authentication, we should really use ldaps:// in the -H option. Otherwise the password will be sent across the network in the clear.With kerberos authentication the password is not sent across the network at all. Next we specify what to search for. In this case I am searching for a user’s account, but it could be in many different locations. We can string filters together using the “(&amp;(filter)(filter)(filter)…)” format. The filters can include a wide range of things. I am limiting the search based on objectCategory=Person, objectClass=User, and sAMAccountName=first.last. It turns out I can get away with just using the sAMAccountName if I know exactly who I am looking for. If we only need one filter, we can use the form “(filter)”, i.e. &#34;(sAMAccountName=first.last)&#34;. Lastly we tell ldapsearch what data we want back. This is optional if you want the entire record, but if we just need one piece it is very useful to get that one thing returned. In this case I am requesting just the memberOf values from the account. This will tell me the groups this user is a member of. If we put this all together we can get something like this (note you can limit the output further with 2&gt;/dev/null , which will redirect the authentication messages which are sent to stderr): [code language=“bash”]$ldapsearch -LLL -H “ldap://dc.my.domain.com” -b “dc=my,dc=domain,dc=com” “(sAMAccountName=last)” memberOf SASL/GSSAPI authentication started SASL username: tech.id@MY.DOMAIN.COM SASL SSF: 112 SASL data security layer installed. dn: CN=Tech.ID,OU=CO,OU=Users,OU=US,DC=MY,DC=DOMAIN,DC=com memberOf: CN=AM IT Infrastructure Group,OU=Distribution Lists,OU=Exchange,OU=US,DC=MY,DC=DOMAIN,DC=COM memberOf: CN=AM AON IT,OU=Distribution Lists,OU=Exchange,OU=US,DC=MY,DC=DOMAIN,DC=COM memberOf: CN=WebReports_ReadOnly,OU=Groups,OU=US,DC=MY,DC=DOMAIN,DC=COM memberOf: CN=IT - MaaS360 AM Compliance Block,OU=Distribution Lists,OU=Exchange,OU=US,DC=MY,DC=DOMAIN,DC=COM memberOf: CN=AM MFA VPN,OU=Distribution Lists,OU=Exchange,OU=US,DC=MY,DC=DOMAIN,DC=COM memberOf: CN=Configuration Management,OU=Distribution Lists,OU=Exchange,OU=US,DC=MY,DC=DOMAIN,DC=COM memberOf: CN=IT - Lync Users in AM,OU=Distribution Lists,OU=Exchange,OU=US,DC=AM,DC=DOMAIN,DC=COM memberOf: CN=IT - Cisco usCUCMCluster02 Users,OU=Distribution Lists,OU=Exchange,OU=US,DC=MY,DC=DOMAIN,DC=COM memberOf: CN=L\#Contractor,OU=Groups,OU=US,DC=MY,DC=DOMAIN,DC=COM memberOf: CN=SCCDUsers-AM,OU=Global,DC=MY,DC=DOMAIN,DC=COM memberOf: CN=IT - Exchange 365 Users in AM,OU=Distribution Lists,OU=Exchange,OU=US,DC=MY,DC=DOMAIN,DC=COM memberOf: CN=AON IT Contractors (US),OU=Distribution Lists,OU=Exchange,OU=US,DC=AM,DC=DOMAIN,DC=COM memberOf: CN=Americas IT Consultants,OU=Distribution Lists,OU=Exchange,OU=US,DC=AM,DC=DOMAIN,DC=COM # refldap://DomainDnsZones.AM.DOMAIN.com/DC=DomainDnsZones,DC=MY,DC=DOMAIN,DC=com [/code]">
  <meta itemprop="datePublished" content="2016-09-22T17:31:02+00:00">
  <meta itemprop="dateModified" content="2016-09-22T17:31:02+00:00">
  <meta itemprop="wordCount" content="880">
  <meta itemprop="keywords" content="OS X General,Shell Script">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Using ldapsearch to get AD data">
  <meta name="twitter:description" content="It has been common for Macs to be bound to Active Directory for a variety of reasons. Recently, the trend has been to move away from binding due to password/lock out issues, the rise of cloud based services, and SSO options that are more comprehensive of the services users need. With the move away from binding, one thing we lose is the ability to look up user and group data with dscl. Here is a decent primer on dscl: http://www.macos.utah.edu/documentation/authentication/dscl.html (just replace every instance of netinfo with dslocal in your mind). With this move we need another tool to query for information and ldapsearch can do this for us. There are a lot of ways to use ldapsearch depending on your end goal. This post will discuss getting user data out of an Active Directory server. In a future post I hope to explain how I am using this to mount the appropriate file shares for users based on their group membership. The basic format for ldapsearch is to tell it where to search, with what account to search, what to search for, and what data to return from any matches. A common search I use is:ldapsearch -LLL -H &#34;ldap://${adURL}&#34; -b &#34;${searchbase}&#34; &#34;(&amp;(objectCategory=Person)(objectClass=User)(sAMAccountName=$endUser))&#34; memberOfWe start with the command, of course. Then the -LLL tells the command to limit the output. I find this gives less output to clean out before I get what I want. The man page says:**\-L** Search results are display in LDAP Data Interchange Format detailed in **ldif**(5). A single **\-L** restricts the output to LDIFv1. A second **\-L** disables comments. A third **\-L** disables printing of the LDIF version. The defaultis to use an extended version of LDIF.Then we need to tell ldapsearch where to search. There are a few parts to this. The first is the -H option with an ldapuri which will often be the DNS name of the domain controller you want to search on in the form “ldap://my.domain.com”. (This can generally be found with host -t SRV _ldap._tcp.my.domain.com). If you have multiple DCs, you can search more than one, but I normally pick a close one to search. Then -b specifies the search base to start the search from. I use the root of the LDAP structure, but if you know where your data is going to be you can be more specific. This will be in the form &#34;dc=my,dc=domain,dc=com&#34; or &#34;OU=Computers,dc=my,dc=domain,dc=com&#34;. Next we need to tell ldapsearch who to search as. In my command above, I don’t make it explicit, but the default is to check for a kerberos ticket granting ticket and use that for authentication. This works nicely for scripting since there is no password to worry about, but you do need to be sure there will be a TGT when the script/command runs. Another form of ldapsearch command would be:ldapsearch -LLL -x -H &#34;ldaps://$adURL&#34; -D &#34;${techNameTest}@my.domain.com&#34; -w &#34;$techPW&#34; -b &#34;${searchbase}&#34; &#34;(&amp;(objectCategory=Person)(objectClass=User)(sAMAccountName=$endUser))&#34; memberOfIn this search we first tell ldapsearch to use simple (username/password) authentication with the -x option. Then specify who to search as with -D and the full form should be &#34;user@domain&#34; or &#34;domain\user&#34;. Then the -w is used to put the password inline with the command. If there are special characters in the password be sure to wrap it in single quotes; &#39;pa$$W0rd!&#39;. For one off searches, you can use -W to have the command prompt for the password. Also note,when using password base authentication, we should really use ldaps:// in the -H option. Otherwise the password will be sent across the network in the clear.With kerberos authentication the password is not sent across the network at all. Next we specify what to search for. In this case I am searching for a user’s account, but it could be in many different locations. We can string filters together using the “(&amp;(filter)(filter)(filter)…)” format. The filters can include a wide range of things. I am limiting the search based on objectCategory=Person, objectClass=User, and sAMAccountName=first.last. It turns out I can get away with just using the sAMAccountName if I know exactly who I am looking for. If we only need one filter, we can use the form “(filter)”, i.e. &#34;(sAMAccountName=first.last)&#34;. Lastly we tell ldapsearch what data we want back. This is optional if you want the entire record, but if we just need one piece it is very useful to get that one thing returned. In this case I am requesting just the memberOf values from the account. This will tell me the groups this user is a member of. If we put this all together we can get something like this (note you can limit the output further with 2&gt;/dev/null , which will redirect the authentication messages which are sent to stderr): [code language=“bash”]$ldapsearch -LLL -H “ldap://dc.my.domain.com” -b “dc=my,dc=domain,dc=com” “(sAMAccountName=last)” memberOf SASL/GSSAPI authentication started SASL username: tech.id@MY.DOMAIN.COM SASL SSF: 112 SASL data security layer installed. dn: CN=Tech.ID,OU=CO,OU=Users,OU=US,DC=MY,DC=DOMAIN,DC=com memberOf: CN=AM IT Infrastructure Group,OU=Distribution Lists,OU=Exchange,OU=US,DC=MY,DC=DOMAIN,DC=COM memberOf: CN=AM AON IT,OU=Distribution Lists,OU=Exchange,OU=US,DC=MY,DC=DOMAIN,DC=COM memberOf: CN=WebReports_ReadOnly,OU=Groups,OU=US,DC=MY,DC=DOMAIN,DC=COM memberOf: CN=IT - MaaS360 AM Compliance Block,OU=Distribution Lists,OU=Exchange,OU=US,DC=MY,DC=DOMAIN,DC=COM memberOf: CN=AM MFA VPN,OU=Distribution Lists,OU=Exchange,OU=US,DC=MY,DC=DOMAIN,DC=COM memberOf: CN=Configuration Management,OU=Distribution Lists,OU=Exchange,OU=US,DC=MY,DC=DOMAIN,DC=COM memberOf: CN=IT - Lync Users in AM,OU=Distribution Lists,OU=Exchange,OU=US,DC=AM,DC=DOMAIN,DC=COM memberOf: CN=IT - Cisco usCUCMCluster02 Users,OU=Distribution Lists,OU=Exchange,OU=US,DC=MY,DC=DOMAIN,DC=COM memberOf: CN=L\#Contractor,OU=Groups,OU=US,DC=MY,DC=DOMAIN,DC=COM memberOf: CN=SCCDUsers-AM,OU=Global,DC=MY,DC=DOMAIN,DC=COM memberOf: CN=IT - Exchange 365 Users in AM,OU=Distribution Lists,OU=Exchange,OU=US,DC=MY,DC=DOMAIN,DC=COM memberOf: CN=AON IT Contractors (US),OU=Distribution Lists,OU=Exchange,OU=US,DC=AM,DC=DOMAIN,DC=COM memberOf: CN=Americas IT Consultants,OU=Distribution Lists,OU=Exchange,OU=US,DC=AM,DC=DOMAIN,DC=COM # refldap://DomainDnsZones.AM.DOMAIN.com/DC=DomainDnsZones,DC=MY,DC=DOMAIN,DC=com [/code]">

	
  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="/" class="f3 fw2 hover-white no-underline white-90 dib">
      
        My Thoughts
      
    </a>
    <div class="flex-l items-center">
      

      
      
<div class="ananke-socials">
  
</div>

    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked ttu">
          
        Posts
      </aside>
      










  <div id="sharing" class="mt3 ananke-socials">
    
  </div>


      <h1 class="f1 athelas mt3 mb1">Using ldapsearch to get AD data</h1>
      
      
      
      <time class="f6 mv4 dib tracked" datetime="2016-09-22T17:31:02Z">September 22, 2016</time>
      

      
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><p>It has been common for Macs to be bound to Active Directory for a variety of reasons.  Recently, the trend has been to move away from binding due to password/lock out issues, the rise of cloud based services, and SSO options that are more comprehensive of the services users need. With the move away from binding, one thing we lose is the ability to look up user and group data with <code>dscl</code>. Here is a decent primer on <code>dscl</code>: http://www.macos.utah.edu/documentation/authentication/dscl.html (just replace every instance of netinfo with dslocal in your mind). With this move we need another tool to query for information and <code>ldapsearch</code> can do this for us.  There are a lot of ways to use <code>ldapsearch</code> depending on your end goal.  This post will discuss getting user data out of an Active Directory server.  In a future post I hope to explain how I am using this to mount the appropriate file shares for users based on their group membership. The basic format for ldapsearch is to tell it where to search, with what account to search, what to search for, and what data to return from any matches.  A common search I use is:<code>ldapsearch -LLL -H &quot;ldap://${adURL}&quot; -b &quot;${searchbase}&quot; &quot;(&amp;(objectCategory=Person)(objectClass=User)(sAMAccountName=$endUser))&quot; memberOf</code>We start with the command, of course.  Then the <code>-LLL</code> tells the command to limit the output.  I find this gives less output to clean out before I get what I want.  The man page says:<code>**\-L**     Search  results  are  display in LDAP Data Interchange Format detailed in **ldif**(5).  A single **\-L** restricts the output to LDIFv1. A second **\-L** disables comments.  A third **\-L** disables printing of the LDIF version.  The defaultis to use an extended version of LDIF.</code>Then we need to tell ldapsearch where to search.  There are a few parts to this.  The first is the <code>-H</code> option with an ldapuri which will often be the DNS name of the domain controller you want to search on in the form &ldquo;ldap://my.domain.com&rdquo;.  (This can generally be found with <code>host -t SRV _ldap._tcp.my.domain.com</code>).  If you have multiple DCs, you can search more than one, but I normally pick a close one to search.  Then <code>-b</code> specifies the search base to start the search from.  I use the root of the LDAP structure, but if you know where your data is going to be you can be more specific.  This will be in the form <code>&quot;dc=my,dc=domain,dc=com&quot;</code> or <code>&quot;OU=Computers,dc=my,dc=domain,dc=com&quot;</code>. Next we need to tell ldapsearch who to search as.  In my command above, I don&rsquo;t make it explicit, but the default is to check for a kerberos ticket granting ticket and use that for authentication.  This works nicely for scripting since there is no password to worry about, but you do need to be sure there will be a TGT when the script/command runs.  Another form of ldapsearch command would be:<code>ldapsearch -LLL -x -H &quot;ldaps://$adURL&quot; -D &quot;${techNameTest}@my.domain.com&quot; -w &quot;$techPW&quot; -b &quot;${searchbase}&quot; &quot;(&amp;(objectCategory=Person)(objectClass=User)(sAMAccountName=$endUser))&quot; memberOf</code>In this search we first tell ldapsearch to use simple (username/password) authentication with the <code>-x</code> option.  Then specify who to search as with <code>-D</code> and the full form should be <code>&quot;user@domain&quot;</code> or <code>&quot;domain\user&quot;</code>.  Then the <code>-w</code> is used to put the password inline with the command.  If there are special characters in the password be sure to wrap it in single quotes; <code>'pa$$W0rd!'</code>.  For one off searches, you can use <code>-W</code> to have the command prompt for the password.  <strong>Also note,when using password base authentication, we should really use ldaps:// in the <code>-H</code> option.  Otherwise the password will be sent across the network in the clear.<img src="https://sneakypockets.wordpress.com/wp-content/uploads/2016/09/screen-shot-2016-09-22-at-10-46-17-am1.png" alt="Screen Shot 2016-09-22 at 10.46.17 AM.png">With kerberos authentication the password is not sent across the network at all.</strong> Next we specify what to search for.  In this case I am searching for a user&rsquo;s account, but it could be in many different locations.  We can string filters together using the &ldquo;(&amp;(filter)(filter)(filter)&hellip;)&rdquo; format.  The filters can include a wide range of things.  I am limiting the search based on <code>objectCategory=Person</code>, <code>objectClass=User</code>, and <code>sAMAccountName=first.last</code>.  It turns out I can get away with just using the sAMAccountName if I know exactly who I am looking for.  If we only need one filter, we can use the form &ldquo;(filter)&rdquo;, i.e. <code>&quot;(sAMAccountName=first.last)&quot;</code>. Lastly we tell <code>ldapsearch</code> what data we want back.  This is optional if you want the entire record, but if we just need one piece it is very useful to get that one thing returned.  In this case I am requesting just the <code>memberOf</code> values from the account.  This will tell me the groups this user is a member of. If we put this all together we can get something like this (note you can limit the output further with <code>2&gt;/dev/null</code> , which will redirect the authentication messages which are sent to stderr): [code language=&ldquo;bash&rdquo;]$ldapsearch -LLL -H &ldquo;ldap://dc.my.domain.com&rdquo; -b &ldquo;dc=my,dc=domain,dc=com&rdquo; &ldquo;(sAMAccountName=last)&rdquo; memberOf SASL/GSSAPI authentication started SASL username: <a href="mailto:tech.id@MY.DOMAIN.COM">tech.id@MY.DOMAIN.COM</a> SASL SSF: 112 SASL data security layer installed. dn: CN=Tech.ID,OU=CO,OU=Users,OU=US,DC=MY,DC=DOMAIN,DC=com memberOf: CN=AM IT Infrastructure Group,OU=Distribution Lists,OU=Exchange,OU=US,DC=MY,DC=DOMAIN,DC=COM memberOf: CN=AM AON IT,OU=Distribution Lists,OU=Exchange,OU=US,DC=MY,DC=DOMAIN,DC=COM memberOf: CN=WebReports_ReadOnly,OU=Groups,OU=US,DC=MY,DC=DOMAIN,DC=COM memberOf: CN=IT - MaaS360 AM Compliance Block,OU=Distribution Lists,OU=Exchange,OU=US,DC=MY,DC=DOMAIN,DC=COM memberOf: CN=AM MFA VPN,OU=Distribution Lists,OU=Exchange,OU=US,DC=MY,DC=DOMAIN,DC=COM memberOf: CN=Configuration Management,OU=Distribution Lists,OU=Exchange,OU=US,DC=MY,DC=DOMAIN,DC=COM memberOf: CN=IT - Lync Users in AM,OU=Distribution Lists,OU=Exchange,OU=US,DC=AM,DC=DOMAIN,DC=COM memberOf: CN=IT - Cisco usCUCMCluster02 Users,OU=Distribution Lists,OU=Exchange,OU=US,DC=MY,DC=DOMAIN,DC=COM memberOf: CN=L\#Contractor,OU=Groups,OU=US,DC=MY,DC=DOMAIN,DC=COM memberOf: CN=SCCDUsers-AM,OU=Global,DC=MY,DC=DOMAIN,DC=COM memberOf: CN=IT - Exchange 365 Users in AM,OU=Distribution Lists,OU=Exchange,OU=US,DC=MY,DC=DOMAIN,DC=COM memberOf: CN=AON IT Contractors (US),OU=Distribution Lists,OU=Exchange,OU=US,DC=AM,DC=DOMAIN,DC=COM memberOf: CN=Americas IT Consultants,OU=Distribution Lists,OU=Exchange,OU=US,DC=AM,DC=DOMAIN,DC=COM # refldap://DomainDnsZones.AM.DOMAIN.com/DC=DomainDnsZones,DC=MY,DC=DOMAIN,DC=com [/code]</p>
<ul class="pa0">
  
   <li class="list di">
     <a href="/tags/os-x-general/" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">OS X General</a>
   </li>
  
   <li class="list di">
     <a href="/tags/shell-script/" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Shell Script</a>
   </li>
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




  <div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links">
    <p class="f5 b mb3">Related</p>
    <ul class="pa0 list">
	   
	     <li  class="mb2">
          <a href="/posts/update-to-network-geektool-script/">Update to network GeekTool script</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/find-the-most-common-user-on-a-system/">Find the most common user on a system</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/macos-sierra-recovery-hd-changes/">macOS Sierra Recovery HD Changes</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/unhide-users-in-10-9-3/">Unhide /Users in 10.9.3</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/keyboard-shortcut-for-system-preferences/">Keyboard shortcut for System Preferences</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/control-if-a-window-opens-when-a-volume-mounts/">Control if a window opens when a volume mounts</a>
        </li>
	    
    </ul>
</div>

</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="http://localhost:1313/" >
    &copy;  Eric Hemmeter 2024 
  </a>
    <div>
<div class="ananke-socials">
  
</div>
</div>
  </div>
</footer>

  </body>
</html>
